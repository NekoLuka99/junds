<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Warenkorb – J&S Transporte</title>
  <link rel="stylesheet" href="style.css">
  <style>
    main {
      padding: 2rem;
    }
    .cart-item {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .cart-item input[type="number"] {
      width: 60px;
      margin-left: 0.5rem;
    }
    .cart-item button {
      margin-left: 1rem;
      background: red;
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
    }
    #submitOrder {
      padding: 1rem 2rem;
      font-size: 1.1rem;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="header-container"></div>
  <main>
    <h2>Warenkorb</h2>
    <div id="cartContainer">Lade Warenkorb...</div>
    <h3 id="totalDisplay"></h3>
    <button id="submitOrder">Bestellung abschicken</button>
  </main>
  
  <script type="module" src="main.js"></script>
  <script type="module">
    import { db } from './firebase.js';
    import { collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

    const cartContainer = document.getElementById("cartContainer");
    const totalDisplay = document.getElementById("totalDisplay");
    const submitBtn = document.getElementById("submitOrder");

    let cart = JSON.parse(localStorage.getItem("cart") || "[]");

    function renderCart() {
      cartContainer.innerHTML = "";
      let total = 0;
      if (cart.length === 0) {
        cartContainer.textContent = "Dein Warenkorb ist leer.";
        totalDisplay.textContent = "";
        return;
      }
      cart.forEach((item, index) => {
        total += item.price * item.menge;
        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <strong>${item.product}</strong><br>
          ${item.price.toFixed(2)} € pro ${item.unit}<br>
          Menge: <input type="number" min="1" value="${item.menge}" data-index="${index}" class="qtyInput">
          <button data-index="${index}" class="removeBtn">Entfernen</button>
        `;
        cartContainer.appendChild(div);
      });
      totalDisplay.textContent = `Gesamt: ${total.toFixed(2)} €`;
    }

    cartContainer.addEventListener("input", e => {
      if (e.target.classList.contains("qtyInput")) {
        const index = parseInt(e.target.dataset.index);
        cart[index].menge = parseInt(e.target.value);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
    });

    cartContainer.addEventListener("click", e => {
      if (e.target.classList.contains("removeBtn")) {
        const index = parseInt(e.target.dataset.index);
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
    });

    submitBtn.addEventListener("click", async () => {
      const username = localStorage.getItem("user")?.toLowerCase();
      if (!username || cart.length === 0) return;

      try {
        await addDoc(collection(db, "orders"), {
          user: username,
          items: cart,
          timestamp: serverTimestamp()
        });
        alert("✅ Bestellung wurde gespeichert!");
        cart = [];
        localStorage.removeItem("cart");
        renderCart();
      } catch (err) {
        alert("Fehler beim Speichern der Bestellung.");
        console.error(err);
      }
    });

    renderCart();
  </script>
</body>
</html>
